<!-- should dom recycled -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://localvoid.github.io/uibench-base/0.1.0/styles.css">
</head>
<body>
    <div id="App"></div>
    <script src="https://localvoid.github.io/uibench-base/0.1.0/uibench.js"></script>
    <script type="module">
        import { Component } from "../src/Component.js";
        import { State } from "../src/State.js";
        import { ObserveComponent } from "../src/ObserveComponent.js";
        const __mergeSetter = (target, prop, value) => {
            return target[prop] = value;
        }
        const mergeDeep = (target, source) => {
            // Iterate through `source` properties and if an `Object` set property to merge of `target` and `source` properties
            for (let key of Object.keys(source)) {
                const currentTarget = target[key];
                const currentSource = source[key];
                if(Array.isArray(currentSource)){
                    for (let index = 0; index < currentSource.length; index++) {
                        const _source = currentSource[index];
                        const _target = currentTarget[index];
                        if(_target !== _source){
                            __mergeSetter(currentTarget, index, _source);
                        }
                    }
                    if(currentSource.length === 0){
                        __mergeSetter(currentTarget, key, currentSource);
                    }
                    
                } else if (currentSource instanceof Object){
                    mergeDeep(target[key], source[key])
                } else if(currentTarget !== currentSource){
                    __mergeSetter(target, key, currentSource);
                }
            }
            return target
        }
        const generateStyleProp = (obj) => Object.entries(obj).map(([k,v])=>`${k}:${v};`).join('');
        const componentEffect = (generate,componentConstructor) => (v, k ,arr,wrapped = null)=>{
            if(!(v instanceof State)){
                v = (typeof wrapped === 'function') ? wrapped(v) : v;
                v = arr[k] = new State(v);
            }
            return generate(new componentConstructor(v));
        }
        const componentEffectCaller = (generate, on) => (v,k,arr)=>{
            return componentEffect(generate, on(v))(v,k,arr);
        };
        const componentValueCaller = (generate, componentConstructor, on)=> (v, k, arr) => componentEffect(generate, componentConstructor)(v, k, arr,on);


        const fragment = Component.fragment;
        class TableCellComponent extends ObserveComponent {
            constructor($state){
                super($state)
            }
            render(u){
                const {text} = this.$state;
                return u(
                    "td", 
                    {
                        text,
                        events: {
                            click: ()=> console.log("Click", text)
                        },
                        className: 'TableCell' 
                    },
                );
            }
        }
        class TableRowComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attr, ...children){
                const {active, id, props} = this.$state;
                return u(
                    'tr',
                    {
                        className: active ? 'TableRow active' : 'TableRow',
                        'data-id': id
                    },
                    u(new TableCellComponent(new State({text:'#' + id}))),
                    fragment(
                        ...props.map(componentValueCaller(u, TableCellComponent,(v)=>({text: v})))
                    )
                );
            }
        }
        class TableComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attr, ...children){
                return u(
                    'table', 
                    {className: 'Table'},
                        u(
                            'tbody',
                            {id : 'tbody'},
                            ...this.$state.items.map(componentEffect(u,TableRowComponent)),
                        )
                );
            }
        }
        class AnimBoxComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attribute, ...children){
                let {time, id} = this.$state;
                return u(
                    'div',
                    {
                        'data-id': id,
                        className: 'AnimBox',
                        style: generateStyleProp({
                            background: `rgba(0,0,0,${(0.5 + ((time % 10) / 10))})`,
                            'border-radius': `${(time % 10)}px`
                        })
                    },
                    
                )
            }
        }
        class AnimComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attribute, ...children){
                return u(
                    'div',
                    {className: 'Anim'},
                    fragment(
                        ...this.$state.items.map(componentEffect(u,AnimBoxComponent))
                    ),
                )
            }
        }
        class TreeLeafComponent extends ObserveComponent {
            constructor($state) {
                super($state);
            }
            render(u){
                let {id} = this.$state;
                return u(
                    'li',
                    {
                        className: 'TreeLeaf',
                        text: id,
                    },
                )
            }
        }
        class TreeNodeComponent extends ObserveComponent {
            constructor($state) {
                super($state);
            }
            render(u, attribute, ...children) {
                return u(
                    'ul',
                    { className: 'TreeNode' },
                    fragment(
                        ...this.$state.children.map(componentEffectCaller(u,(item)=> item.container ? TreeNodeComponent : TreeLeafComponent))
                    )
                )
            }
            mutation(props){
            }
        }
        class TreeComponent extends ObserveComponent {
            constructor($state) {
                if(!($state.root instanceof State)){
                    $state.root = new State($state.root);
                }
                super($state);
            }
            render(u, attribute, ...children) {
                return u(
                    'div',
                    { className: 'Tree' },
                    u(new TreeNodeComponent(this.$state.root))
                )
            }
        }
        class MainComponent extends ObserveComponent {
            constructor(state){
                super(state);
            }
            render(u, { text }, ...children) {
                const state = this.$state;

                let component = null;
                let {location} = state;
                switch (location) {
                    case 'table':
                        component = u(new TableComponent(state.table))
                        break;
                    case 'anim':
                        component =  u(new AnimComponent(state.anim))
                        break;
                    case 'tree':
                        component = u(new TreeComponent(state.tree))
                        break;
                    default:
                        break;
                }
                return u(
                    "div",
                    { className: 'Main'},
                    component
                )
            }
        }
        
        uibench.init("SchemeDom-observe", "1.0.0");
        document.addEventListener("DOMContentLoaded", (e) => {
            const container = document.querySelector("#App");

            let component = null;
            let prevState = {};
            uibench.run(
                (state,mode) => {
                    switch(mode){
                        case 'init':
                            component = new MainComponent(new State({
                                table: new State(state.table),
                                anim: new State(state.anim),
                                tree: new State(state.tree),
                                home: state.home,
                                location: state.location
                            }));
                            Component.mount(container, component);
                            break;
                        case 'update':
                            const {table,anim,tree,location} = state;
                            switch (location) {
                                case 'table':
                                    mergeDeep(table, state.table);
                                    break;
                                case 'anim':
                                    mergeDeep(anim, state.anim);
                                    break;
                                case 'tree':
                                    mergeDeep(tree, state.tree);
                                    break;
                                default:
                                    break;
                            }
                            component.$state.location = location;
                        default :
                            break;   
                    }
                    prevState = state;
                },
                (samples) => {
                    document.body.innerHTML = "<pre>" + JSON.stringify(samples, null, " ") + "</pre>";
                }
            );
        });
    </script>
</body>
</html>