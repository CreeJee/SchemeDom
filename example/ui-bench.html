<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://localvoid.github.io/uibench-base/0.1.0/styles.css">
</head>

<body>
    <div id="App"></div>
    <script src="https://localvoid.github.io/uibench-base/0.1.0/uibench.js"></script>
    <script type="module">
        import { Component } from "../src/Component.js";
        import { State } from "../src/State.js";
        import { ObserveComponent } from "../src/ObserveComponent.js";

        const generateStyleProp = (obj) => Object.entries(obj).map(([k, v]) => `${k}:${v};`).join('');
        const fragment = Component.fragment;
        class TableCellComponent extends Component {
            constructor(text) {
                super();
                this.text = text;
            }
            render(u) {
                const { text } = this;
                return u(
                    "td",
                    {
                        text: (text ? text : '#text'),
                        events: {
                            click: () => console.log("Click", text)
                        },
                        className: 'TableCell'
                    },
                );
            }
        }
        class TableRowComponent extends Component {
            constructor(props) {
                super(props);
            }
            render(u, attr, ...children) {
                const { active, id, props } = this.props;
                return u(
                    'tr',
                    {
                        className: active ? 'TableRow active' : 'TableRow',
                        'data-id': id
                    },
                    u(new TableCellComponent('#' + id)),
                    fragment(
                        ...props.map(
                            (text) => u(new TableCellComponent(text))
                        )
                    )
                );
            }
        }
        class TableComponent extends Component {
            constructor(props) {
                super(props);
            }
            render(u, attr, ...children) {
                return u(
                    'table',
                    { className: 'Table' },
                    u(
                        'tbody',
                        { id: 'tbody' },
                        ...this.props.items.map(
                            (item) => u(new TableRowComponent(item))
                        ),
                    )
                );
            }
        }
        class AnimBoxComponent extends Component {
            constructor($state) {
                super($state);
            }
            render(u, attribute, ...children) {
                let { time, id } = this.props;
                return u(
                    'div',
                    {
                        'data-id': id,
                        className: 'AnimBox',
                        style: generateStyleProp({
                            background: `rgba(0,0,0,${(0.5 + ((time % 10) / 10))})`,
                            'border-radius': `${(time % 10)}px`
                        })
                    },

                )
            }
        }
        class AnimComponent extends Component {
            constructor(props) {
                super(props);
            }
            render(u, attribute, ...children) {
                return u(
                    'div',
                    { className: 'Anim' },
                    fragment(
                        ...this.props.items.map(
                            (item) => u(new AnimBoxComponent(item))
                        )
                    ),
                )
            }
        }
        class TreeLeafComponent extends Component {
            constructor(props) {
                super(props);
            }
            render(u) {
                let { id } = this.props
                return u(
                    'li',
                    {
                        className: 'TreeLeaf',
                        text: id,
                    },
                )
            }
        }
        class TreeNodeComponent extends Component {
            constructor(props) {
                super(props);
            }
            render(u, attribute, ...children) {
                return u(
                    'ul',
                    { className: 'TreeNode' },
                    fragment(
                        ...this.props.children.map(
                            (item) => u(new (item.container ? TreeNodeComponent : TreeLeafComponent)(item))
                        )
                    )
                )
            }
        }
        class TreeComponent extends Component {
            constructor(props) {
                super(props);
            }
            render(u, attribute, ...children) {
                return u(
                    'div',
                    { className: 'Tree' },
                    u(new TreeNodeComponent(this.props))
                )
            }
        }


        class MainComponent extends Component {
            constructor($state) {
                super($state);
                this.$state = $state;
            }
            render(u, { text }, ...children) {
                const { $state } = this;

                let component = null;
                let { location } = $state;
                switch (location) {
                    case 'table':
                        component = u(new TableComponent($state.table))
                        break;
                    case 'anim':
                        component = u(new AnimComponent($state.anim))
                        break;
                    case 'tree':
                        component = u(new TreeComponent($state.tree.root))
                        break;
                    default:
                        break;
                }

                return u(
                    "div",
                    { text: '#section', className: 'Main' },
                    component
                )
            }
        }

        uibench.init("SchemeDom-just-append", "1.0.0");

        document.addEventListener("DOMContentLoaded", (e) => {
            const container = document.querySelector("#App");
            let component = null;
            uibench.run(
                (state, mode) => {
                    // switch (mode) {
                    //     case 'init':
                    //         component = new MainComponent(new State(state));
                    //         Component.mount(container, component);
                    //         break;
                    //     case 'update':
                    //         component.$state.set(state);
                    //     default:
                    //         break;
                    // }
                    
                    component = new MainComponent(state);
                    Component.mount(container, component);
                },
                (samples) => {
                    document.body.innerHTML = "<pre>" + JSON.stringify(samples, null, " ") + "</pre>";
                }
            );
        });
    </script>
</body>

</html>