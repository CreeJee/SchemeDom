<!-- should dom recycled -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://localvoid.github.io/uibench-base/0.1.0/styles.css">
</head>
<body>
    <div id="App"></div>
    <script src="https://localvoid.github.io/uibench-base/0.1.0/uibench.js"></script>
    <script type="module">
        import { Component } from "../src/Component.js";
        import { State } from "../src/State.js";
        import { ObserveComponent } from "../src/ObserveComponent.js";

        const generateStyleProp = (obj) => Object.entries(obj).map(([k,v])=>`${k}:${v};`).join('');
        const componentEffect = (generate,ComponentConstructor) => (v, k ,arr)=>{
            if(!(v instanceof State)){
                v = arr[k] = new State(v);
            }
            return generate(new ComponentConstructor(v));
        }
        const componentEffectCaller = (generate,on) => (v,k,arr)=>componentEffect(generate,on(v));
        const fragment = Component.fragment;
        class TableCellComponent extends Component {
            constructor({text}){
                super()
                this.text = text;
            }
            render(u){
                const {text} = this;
                return u(
                    "td", 
                    {
                        text: (text ? text: '#text'),
                        events: {
                            click: ()=> console.log("Click", text)
                        },
                        className: 'TableCell' 
                    },
                );
            }
        }
        class TableRowComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attr, ...children){
                const {active, id, props} = this.$state;
                return u(
                    'tr',
                    {
                        className: active ? 'TableRow active' : 'TableRow',
                        'data-id': id
                    },
                    u(new TableCellComponent('#' + id)),
                    fragment(
                        ...props.map((item)=>u(new TableCellComponent(item)))
                    )
                );
            }
        }
        class TableComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attr, ...children){
                debugger;
                return u(
                    'table', 
                    {className: 'Table'},
                        u(
                            'tbody',
                            {id : 'tbody'},
                            ...this.$state.items.map(componentEffect(u,TableRowComponent)),
                        )
                );
            }
        }
        class AnimBoxComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attribute, ...children){
                let {time, id} = this.$state;
                return u(
                    'div',
                    {
                        'data-id': id,
                        className: 'AnimBox',
                        style: generateStyleProp({
                            background: `rgba(0,0,0,${(0.5 + ((time % 10) / 10))})`,
                            'border-radius': `${(time % 10)}px`
                        })
                    },
                    
                )
            }
        }
        class AnimComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, attribute, ...children){
                return u(
                    'div',
                    {className: 'Anim'},
                    fragment(
                        ...this.$state.items.map(componentEffect(u,AnimBoxComponent))
                    ),
                )
            }
        }
        class TreeLeafComponent extends ObserveComponent {
            constructor($state) {
                super($state);
            }
            render(u){
                let {id} = this.$state;
                return u(
                    'li',
                    {
                        className: 'TreeLeaf',
                        text: id,
                    },
                )
            }
        }
        class TreeNodeComponent extends ObserveComponent {
            constructor($state) {
                super($state);
            }
            render(u, attribute, ...children) {
                return u(
                    'ul',
                    { className: 'TreeNode' },
                    fragment(
                        ...this.$state.children.map(componentEffectCaller(u,(item)=> item.container ? TreeNodeComponent : TreeLeafComponent))
                    )
                )
            }
            mutation(props){
            }
        }
        class TreeComponent extends ObserveComponent {
            constructor($state) {
                super($state);
            }
            render(u, attribute, ...children) {
                this.$state.root = new State(this.$state.root);
                return u(
                    'div',
                    { className: 'Tree' },
                    u(new TreeNodeComponent(this.$state.root))
                )
            }
        }


        class MainComponent extends ObserveComponent {
            constructor($state){
                super($state);
            }
            render(u, { text }, ...children) {
                const {$state} = this;

                let component = null;
                let {location} = $state;
                if (!($state.table instanceof State)) {
                    $state.table = new State($state.table);
                    $state.anim = new State($state.anim);
                    $state.tree = new State($state.tree);
                }
                switch (location) {
                    case 'table':
                        component = u(new TableComponent($state.table))
                        break;
                    case 'anim':
                        component =  u(new AnimComponent($state.anim))
                        break;
                    case 'tree':
                        component = u(new TreeComponent($state.tree))
                        break;
                    default:
                        break;
                }
                return u(
                    "div",
                    { className: 'Main'},
                    component
                )
            }
            mutation() {

            }
        }
        
        uibench.init("SchemeDom", "1.0.0");
        
        document.addEventListener("DOMContentLoaded", (e) => {
            const container = document.querySelector("#App");

            let component = null;
            uibench.run(
                (state,mode) => {
                    switch(mode){
                        case 'init':
                            component = new MainComponent(new State(state));
                            Component.mount(container, component);
                            break;
                        default :
                            break;   
                    }
                },
                (samples) => {
                    document.body.innerHTML = "<pre>" + JSON.stringify(samples, null, " ") + "</pre>";
                }
            );
        });
    </script>
</body>
</html>